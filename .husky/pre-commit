#!/bin/sh

# Pre-Commit Hook for ZeitPal
# Runs multiple checks to prevent deployment-breaking issues

echo ""
echo "========================================"
echo "Running pre-commit checks..."
echo "========================================"
echo ""

# Track if any check fails
CHECKS_PASSED=1

# =========================================
# 1. SECRET DETECTION
# =========================================
echo "üîç [1/4] Checking for secrets in staged files..."

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No staged files to check"
else
    # Define patterns to detect secrets
    SECRET_PATTERNS=(
        # AWS
        'AKIA[0-9A-Z]{16}'
        'aws_secret_access_key\s*=\s*["\047][A-Za-z0-9/+=]{40}["\047]'

        # Private Keys
        '-----BEGIN (RSA |DSA |EC |OPENSSH |PGP )?PRIVATE KEY( BLOCK)?-----'

        # Generic API Keys and Tokens
        '[aA][pP][iI]_?[kK][eE][yY]\s*[:=]\s*["\047][A-Za-z0-9_\-]{20,}["\047]'
        '[aA][pP][iI]_?[sS][eE][cC][rR][eE][tT]\s*[:=]\s*["\047][A-Za-z0-9_\-]{20,}["\047]'
        '[sS][eE][cC][rR][eE][tT]_?[kK][eE][yY]\s*[:=]\s*["\047][A-Za-z0-9_\-]{20,}["\047]'

        # Supabase
        'sb[op]_[A-Za-z0-9]{20,}'
        'service_role\s*[:=]\s*["\047]eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+["\047]'

        # JWT Tokens
        'eyJ[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}'

        # Generic secrets/passwords in config
        '[pP][aA][sS][sS][wW][oO][rR][dD]\s*[:=]\s*["\047][^"\047]{8,}["\047]'

        # Database URLs with passwords
        '(mysql|postgres|postgresql|mongodb|redis):\/\/[^:]+:[^@]+@'

        # GitHub/GitLab tokens
        'gh[pousr]_[A-Za-z0-9_]{36,}'
        'glpat-[A-Za-z0-9\-]{20,}'

        # Slack tokens
        'xox[baprs]-[A-Za-z0-9\-]{10,}'

        # Stripe
        'sk_live_[A-Za-z0-9]{24,}'
        'sk_test_[A-Za-z0-9]{24,}'
        'rk_live_[A-Za-z0-9]{24,}'

        # SendGrid
        'SG\.[A-Za-z0-9_\-]{22}\.[A-Za-z0-9_\-]{43}'

        # Twilio
        'SK[A-Za-z0-9]{32}'

        # OpenAI
        'sk-[A-Za-z0-9]{48}'

        # Anthropic
        'sk-ant-[A-Za-z0-9\-]{40,}'

        # Google
        'AIza[A-Za-z0-9_\-]{35}'

        # Cloudflare
        'cloudflare.*["\047][A-Za-z0-9_\-]{37}["\047]'
    )

    # Files to ignore
    IGNORE_PATTERNS=(
        '\.example$'
        '\.sample$'
        '\.template$'
        '\.md$'
        'package-lock\.json$'
        'pnpm-lock\.yaml$'
        'yarn\.lock$'
    )

    SECRETS_FOUND=0
    FINDINGS=""

    for FILE in $STAGED_FILES; do
        # Skip if file doesn't exist
        if [ ! -f "$FILE" ]; then
            continue
        fi

        # Skip ignored file patterns
        SKIP=0
        for IGNORE in "${IGNORE_PATTERNS[@]}"; do
            if echo "$FILE" | grep -qE "$IGNORE"; then
                SKIP=1
                break
            fi
        done

        if [ $SKIP -eq 1 ]; then
            continue
        fi

        # Check for each secret pattern
        for PATTERN in "${SECRET_PATTERNS[@]}"; do
            MATCHES=$(git show ":$FILE" 2>/dev/null | grep -nE "$PATTERN" 2>/dev/null || true)

            if [ -n "$MATCHES" ]; then
                SECRETS_FOUND=1
                FINDINGS="$FINDINGS\n‚ùå Potential secret found in $FILE:\n$MATCHES\n"
            fi
        done
    done

    if [ $SECRETS_FOUND -eq 1 ]; then
        echo ""
        echo "üö® SECRET DETECTION FAILED!"
        echo -e "$FINDINGS"
        CHECKS_PASSED=0
    else
        echo "‚úÖ No secrets detected"
    fi
fi

# =========================================
# 2. EDGE RUNTIME CHECK (API routes only)
# =========================================
echo ""
echo "üåê [2/4] Checking for Edge Runtime declarations in API routes..."

# Find all route.ts files in apps/web/app/api that are staged
EDGE_ISSUES=""
EDGE_CHECK_FAILED=0

for FILE in $STAGED_FILES; do
    # Only check route.ts files in the api directory
    if echo "$FILE" | grep -qE "^apps/web/app/api/.*route\.ts$"; then
        # Check if the file exists
        if [ -f "$FILE" ]; then
            # API routes must have edge runtime export
            if ! grep -q "export const runtime = 'edge'" "$FILE"; then
                EDGE_ISSUES="$EDGE_ISSUES\n‚ùå Missing 'export const runtime = \"edge\"' in: $FILE"
                EDGE_CHECK_FAILED=1
            fi
        fi
    fi
done

if [ $EDGE_CHECK_FAILED -eq 1 ]; then
    echo -e "$EDGE_ISSUES"
    echo ""
    echo "üö® EDGE RUNTIME CHECK FAILED!"
    echo "All API route.ts files must include: export const runtime = 'edge'"
    echo "This is required for Cloudflare Workers deployment."
    CHECKS_PASSED=0
else
    echo "‚úÖ All API routes have Edge Runtime declaration"
fi

# =========================================
# 3. TYPESCRIPT TYPE CHECK
# =========================================
echo ""
echo "üìù [3/4] Running TypeScript type check..."

# Check if any TypeScript files are staged
TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)

if [ -z "$TS_FILES" ]; then
    echo "‚úÖ No TypeScript files to check"
else
    pnpm typecheck
    TYPECHECK_EXIT=$?
    if [ $TYPECHECK_EXIT -eq 0 ]; then
        echo "‚úÖ TypeScript check passed"
    else
        echo ""
        echo "üö® TYPESCRIPT CHECK FAILED!"
        echo "Please fix the type errors before committing."
        CHECKS_PASSED=0
    fi
fi

# =========================================
# 4. LINTING CHECK
# =========================================
echo ""
echo "üîß [4/4] Running ESLint check..."

# Check if any lintable files are staged
LINT_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx)$' || true)

if [ -z "$LINT_FILES" ]; then
    echo "‚úÖ No files to lint"
else
    pnpm lint
    LINT_EXIT=$?
    if [ $LINT_EXIT -eq 0 ]; then
        echo "‚úÖ Lint check passed"
    else
        echo ""
        echo "üö® LINT CHECK FAILED!"
        echo "Please fix the linting errors before committing."
        echo "Run 'pnpm lint:fix' to auto-fix some issues."
        CHECKS_PASSED=0
    fi
fi

# =========================================
# FINAL RESULT
# =========================================
echo ""
echo "========================================"

if [ $CHECKS_PASSED -eq 0 ]; then
    echo "‚ùå PRE-COMMIT CHECKS FAILED"
    echo "========================================"
    echo ""
    echo "Please fix the issues above before committing."
    echo "To bypass (not recommended): git commit --no-verify"
    echo ""
    exit 1
else
    echo "‚úÖ ALL PRE-COMMIT CHECKS PASSED"
    echo "========================================"
    echo ""
    exit 0
fi
